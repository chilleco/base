apiVersion: 1

# Allow UI modifications to override provisioned values (persists across restarts)
# This enables setting message_thread_id via Grafana UI for topic support
allowUiUpdates: true

# Telegram contact points for alerting
# Uses Grafana's native Telegram integration (available since Grafana 10.4)
#
# Required environment variables:
#   TELEGRAM_ALERT_BOT_TOKEN - Telegram bot token
#
# IMPORTANT: chatid is hardcoded due to Grafana bug #69950 where env var
# substitution fails for numeric values (interprets as int, not string).
# To change chat ID, either edit this file or use Grafana UI (allowUiUpdates=true).
#
# Topic support (message_thread_id):
#   Hardcoded due to Grafana bug #84296 (same issue as chatid).

contactPoints:
  - orgId: 1
    name: telegram-critical
    receivers:
      - uid: telegram-critical-receiver
        type: telegram
        settings:
          bottoken: ${TELEGRAM_ALERT_BOT_TOKEN}
          chatid: '-1003428645182'
          message_thread_id: '626'
          parse_mode: HTML
          disable_web_page_preview: true
          disable_notification: false
          message: |
            {{- if gt (len .Alerts.Firing) 0 }}
            üö® <b>CRITICAL</b> {{ .CommonLabels.alertname }}
            {{ if .CommonAnnotations.summary }}{{ .CommonAnnotations.summary }}{{ end }}
            <b>Firing:</b> {{ len .Alerts.Firing }}{{ range .Alerts.Firing }}
            ‚Ä¢ {{ .Labels.alertname }}{{ if .Labels.instance }} <code>{{ .Labels.instance }}</code>{{ end }}
              {{ if .DashboardURL }}<a href="{{ .DashboardURL }}">Dashboard</a>{{ end }} {{ if .PanelURL }}<a href="{{ .PanelURL }}">Panel</a>{{ end }} {{ if .SilenceURL }}<a href="{{ .SilenceURL }}">Silence</a>{{ end }}{{ end }}
            {{- end }}
            {{- if gt (len .Alerts.Resolved) 0 }}
            ‚úÖ <b>RESOLVED</b> {{ .CommonLabels.alertname }}
            <b>Resolved:</b> {{ len .Alerts.Resolved }}{{ range .Alerts.Resolved }}
            ‚úì {{ .Labels.alertname }}{{ if .Labels.instance }} <code>{{ .Labels.instance }}</code>{{ end }}{{ end }}
            {{- end }}
        disableResolveMessage: false

  - orgId: 1
    name: telegram-warning
    receivers:
      - uid: telegram-warning-receiver
        type: telegram
        settings:
          bottoken: ${TELEGRAM_ALERT_BOT_TOKEN}
          chatid: '-1003428645182'
          message_thread_id: '626'
          parse_mode: HTML
          disable_web_page_preview: true
          disable_notification: false
          message: |
            {{- if gt (len .Alerts.Firing) 0 }}
            ‚ö†Ô∏è <b>WARNING</b> {{ .CommonLabels.alertname }}
            {{ if .CommonAnnotations.summary }}{{ .CommonAnnotations.summary }}{{ end }}
            <b>Firing:</b> {{ len .Alerts.Firing }}{{ range .Alerts.Firing }}
            ‚Ä¢ {{ .Labels.alertname }}{{ if .Labels.instance }} <code>{{ .Labels.instance }}</code>{{ end }}
              {{ if .DashboardURL }}<a href="{{ .DashboardURL }}">Dashboard</a>{{ end }} {{ if .PanelURL }}<a href="{{ .PanelURL }}">Panel</a>{{ end }} {{ if .SilenceURL }}<a href="{{ .SilenceURL }}">Silence</a>{{ end }}{{ end }}
            {{- end }}
            {{- if gt (len .Alerts.Resolved) 0 }}
            ‚úÖ <b>RESOLVED</b> {{ .CommonLabels.alertname }}
            <b>Resolved:</b> {{ len .Alerts.Resolved }}{{ range .Alerts.Resolved }}
            ‚úì {{ .Labels.alertname }}{{ if .Labels.instance }} <code>{{ .Labels.instance }}</code>{{ end }}{{ end }}
            {{- end }}
        disableResolveMessage: false

  - orgId: 1
    name: telegram-info
    receivers:
      - uid: telegram-info-receiver
        type: telegram
        settings:
          bottoken: ${TELEGRAM_ALERT_BOT_TOKEN}
          chatid: '-1003428645182'
          message_thread_id: '626'
          parse_mode: HTML
          disable_web_page_preview: true
          disable_notification: true
          message: |
            {{- if gt (len .Alerts.Firing) 0 }}
            ‚ÑπÔ∏è <b>INFO</b> {{ .CommonLabels.alertname }}
            {{ if .CommonAnnotations.summary }}{{ .CommonAnnotations.summary }}{{ end }}
            <b>Firing:</b> {{ len .Alerts.Firing }}{{ range .Alerts.Firing }}
            ‚Ä¢ {{ .Labels.alertname }}{{ if .Labels.instance }} <code>{{ .Labels.instance }}</code>{{ end }}
              {{ if .DashboardURL }}<a href="{{ .DashboardURL }}">Dashboard</a>{{ end }} {{ if .PanelURL }}<a href="{{ .PanelURL }}">Panel</a>{{ end }} {{ if .SilenceURL }}<a href="{{ .SilenceURL }}">Silence</a>{{ end }}{{ end }}
            {{- end }}
            {{- if gt (len .Alerts.Resolved) 0 }}
            ‚úÖ <b>RESOLVED</b> {{ .CommonLabels.alertname }}
            <b>Resolved:</b> {{ len .Alerts.Resolved }}{{ range .Alerts.Resolved }}
            ‚úì {{ .Labels.alertname }}{{ if .Labels.instance }} <code>{{ .Labels.instance }}</code>{{ end }}{{ end }}
            {{- end }}
        disableResolveMessage: false
